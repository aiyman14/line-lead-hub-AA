name: Desktop Build

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x86_64
          - os: windows-latest
            platform: windows-x86_64
          - os: macos-latest
            platform: darwin-universal

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf
          sudo apt-get install -y libayatana-appindicator3-dev || sudo apt-get install -y libappindicator3-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS universal targets
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Install frontend deps
        shell: bash
        run: npm ci

      - name: Write Tauri updater signing key
        shell: bash
        run: |
          mkdir -p ~/.tauri
          printf '%s' "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" > ~/.tauri/tauri.key
          chmod 600 ~/.tauri/tauri.key

      # ---- macOS: import Developer ID cert (.p12) into keychain ----
      - name: Import Apple Developer ID certificate
        if: matrix.os == 'macos-latest'
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      # ---- BUILD ----
      - name: Build desktop app (Linux/Windows)
        if: matrix.os != 'macos-latest'
        shell: bash
        run: npm run tauri:build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build desktop app (macOS Universal)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: npm run tauri:build -- --target universal-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      # ---- macOS: codesign properly + rebuild DMG from signed .app ----
      - name: Codesign app properly + rebuild DMG (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail

          mkdir -p artifacts

          # Find the built .app
          APP_PATH="$(find "src-tauri/target/universal-apple-darwin/release/bundle/macos" -maxdepth 2 -name "*.app" -type d | head -1 || true)"
          if [ -z "${APP_PATH:-}" ]; then
            APP_PATH="$(find "src-tauri/target/release/bundle/macos" -maxdepth 2 -name "*.app" -type d | head -1 || true)"
          fi

          if [ -z "${APP_PATH:-}" ] || [ ! -d "$APP_PATH" ]; then
            echo "Could not find .app to sign" >&2
            exit 1
          fi

          echo "App found: $APP_PATH"
          echo "Signing identity: $APPLE_SIGNING_IDENTITY"

          ENTITLEMENTS="src-tauri/entitlements.plist"
          if [ ! -f "$ENTITLEMENTS" ]; then
            echo "WARNING: $ENTITLEMENTS not found. Signing without entitlements."
            ENTITLEMENTS=""
          fi

          # Sign nested code first (Frameworks, dylibs, helpers), then the app
          echo "Signing nested items..."
          while IFS= read -r item; do
            if [ -n "${ENTITLEMENTS:-}" ]; then
              codesign --force --options runtime --timestamp \
                --sign "$APPLE_SIGNING_IDENTITY" \
                --entitlements "$ENTITLEMENTS" \
                "$item"
            else
              codesign --force --options runtime --timestamp \
                --sign "$APPLE_SIGNING_IDENTITY" \
                "$item"
            fi
          done < <(find "$APP_PATH" -type f \( -name "*.dylib" -o -name "*.so" -o -perm -111 \) -print || true)

          echo "Signing the app bundle..."
          if [ -n "${ENTITLEMENTS:-}" ]; then
            codesign --force --deep --options runtime --timestamp \
              --sign "$APPLE_SIGNING_IDENTITY" \
              --entitlements "$ENTITLEMENTS" \
              "$APP_PATH"
          else
            codesign --force --deep --options runtime --timestamp \
              --sign "$APPLE_SIGNING_IDENTITY" \
              "$APP_PATH"
          fi

          echo "Verifying codesign..."
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          spctl -a -vv "$APP_PATH" || true

           # Rebuild a *Finder-styled* DMG from the signed app (with background + /Applications link)
           STAGE_DIR="$(pwd)/artifacts/dmg_stage"
           rm -rf "$STAGE_DIR"
           mkdir -p "$STAGE_DIR"
           cp -R "$APP_PATH" "$STAGE_DIR/"

           DMG_OUT="artifacts/Production_Portal_universal.dmg"
           rm -f "$DMG_OUT"

           APP_NAME="$(basename "$APP_PATH")"
           BACKGROUND="$(pwd)/src-tauri/dmg-background.png"

           echo "Creating DMG (with instructions + Applications link): $DMG_OUT"

           # create-dmg is what gives us the background image + Applications alias + icon positioning
           if ! command -v create-dmg >/dev/null 2>&1; then
             echo "Installing create-dmg..."
             brew update
             brew install create-dmg
           fi

           if [ ! -f "$BACKGROUND" ]; then
             echo "WARNING: DMG background not found at $BACKGROUND (DMG will still be created, but without instructions image)" >&2
             BACKGROUND=""
           fi

           if [ -n "${BACKGROUND:-}" ]; then
             create-dmg \
               --volname "Production Portal" \
               --window-pos 200 120 \
               --window-size 660 500 \
               --icon-size 128 \
               --background "$BACKGROUND" \
               --icon "$APP_NAME" 180 320 \
               --app-drop-link 480 320 \
               "$DMG_OUT" \
               "$STAGE_DIR"
           else
             create-dmg \
               --volname "Production Portal" \
               --window-pos 200 120 \
               --window-size 660 500 \
               --icon-size 128 \
               --icon "$APP_NAME" 180 320 \
               --app-drop-link 480 320 \
               "$DMG_OUT" \
               "$STAGE_DIR"
           fi

           echo "DMG created:"
           ls -lh "$DMG_OUT"

          echo "DMG created:"
          ls -lh "$DMG_OUT"

      # ---- macOS: notarize + staple the rebuilt DMG ----
      - name: Notarize + staple DMG (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          DMG="artifacts/Production_Portal_universal.dmg"
          if [ ! -f "$DMG" ]; then
            echo "Missing DMG at $DMG" >&2
            exit 1
          fi

          retry() {
            local n=0 max=6 delay=20
            until "$@"; do
              n=$((n+1))
              if [ "$n" -ge "$max" ]; then
                echo "Command failed after $n attempts: $*" >&2
                return 1
              fi
              echo "Command failed (attempt $n/$max). Retrying in ${delay}s..." >&2
              sleep "$delay"
              delay=$((delay*2))
            done
          }

          echo "Submitting for notarization (wait): $DMG"

          SUBMIT_JSON="$(retry xcrun notarytool submit "$DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait \
            --output-format json)"

          echo "$SUBMIT_JSON"

          UUID="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("id",""))' "$SUBMIT_JSON")"
          STATUS="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("status",""))' "$SUBMIT_JSON")"

          echo "Notary submission id: $UUID"
          echo "Notary status: $STATUS"

          if [ -z "${UUID:-}" ]; then
            echo "ERROR: Could not extract notary submission id." >&2
            exit 1
          fi

          if [ "$STATUS" != "Accepted" ]; then
            echo "Notarization not accepted. Fetching log..." >&2
            xcrun notarytool log "$UUID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" || true
            exit 1
          fi

          echo "Waiting for ticket propagation..."
          sleep 120

          echo "Stapling notarization ticket..."
          retry xcrun stapler staple "$DMG"

          echo "Stapler validate..."
          xcrun stapler validate "$DMG" || true

          echo "Gatekeeper verification..."
          spctl -a -vv "$DMG" || true

      # ---- COLLECT ARTIFACTS ----
      - name: Collect artifacts (Linux)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          APPIMAGE=$(find src-tauri/target/release/bundle -name "*.AppImage" -type f | head -1 || true)
          if [ -n "${APPIMAGE:-}" ] && [ -f "$APPIMAGE" ]; then
            cp "$APPIMAGE" artifacts/
            [ -f "$APPIMAGE.sig" ] && cp "$APPIMAGE.sig" artifacts/linux-x86_64.sig || true
          fi
          find src-tauri/target/release/bundle -name "*.deb" -type f -exec cp {} artifacts/ \; || true
          find src-tauri/target/release/bundle -name "*.rpm" -type f -exec cp {} artifacts/ \; || true

      - name: Collect artifacts (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          MSI=$(find src-tauri/target/release/bundle -name "*.msi" -type f | head -1 || true)
          if [ -n "${MSI:-}" ] && [ -f "$MSI" ]; then
            cp "$MSI" artifacts/
            [ -f "$MSI.sig" ] && cp "$MSI.sig" artifacts/windows-x86_64.sig || true
          fi
          find src-tauri/target/release/bundle -name "*.exe" -type f -exec cp {} artifacts/ \; || true

      - name: Collect artifacts (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts

          # Keep our notarized DMG
          [ -f artifacts/Production_Portal_universal.dmg ] || (echo "Missing notarized DMG" >&2 && exit 1)

          # Also capture updater artifact if present
          MAC_TAR=$(find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app.tar.gz" -type f 2>/dev/null | head -1 || true)
          if [ -n "${MAC_TAR:-}" ] && [ -f "$MAC_TAR" ]; then
            cp "$MAC_TAR" artifacts/
            [ -f "$MAC_TAR.sig" ] && cp "$MAC_TAR.sig" artifacts/darwin-universal.sig || true
          fi

      - name: Upload installers
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.platform }}
          if-no-files-found: error
          path: artifacts/

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')

    steps:
      - name: Download all installers
        uses: actions/download-artifact@v4
        with:
          pattern: installers-*
          path: dist
          merge-multiple: true

      - name: List downloaded artifacts
        shell: bash
        run: |
          echo "Downloaded artifacts:"
          find dist -type f -ls

      - name: Create Release + Upload Assets
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Production Portal ${{ github.ref_name }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.dmg
            dist/*.app.tar.gz
            dist/*.msi
            dist/*.exe
            dist/*.sig
          token: ${{ secrets.GITHUB_TOKEN }}
