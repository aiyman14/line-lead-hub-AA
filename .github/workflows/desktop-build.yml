name: Desktop Build

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x86_64
          - os: windows-latest
            platform: windows-x86_64
          - os: macos-latest
            platform: darwin-universal

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf
          sudo apt-get install -y libayatana-appindicator3-dev || sudo apt-get install -y libappindicator3-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS universal targets
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Install frontend deps
        shell: bash
        run: npm ci

      - name: Write Tauri updater signing key
        shell: bash
        run: |
          mkdir -p ~/.tauri
          printf '%s' "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" > ~/.tauri/production-portal.key
          chmod 600 ~/.tauri/production-portal.key

      - name: Import Apple Developer ID certificate (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail

          echo "$APPLE_CERTIFICATE" | base64 --decode > cert.p12

          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24)"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          security import cert.p12 -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "Identities in keychain:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true

      - name: Build desktop app (Linux/Windows)
        if: matrix.os != 'macos-latest'
        shell: bash
        run: npm run tauri:build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build desktop app (macOS Universal)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: npm run tauri:build -- --target universal-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Codesign app properly + rebuild DMG (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail

          APP_PATH="$(find "src-tauri/target/universal-apple-darwin/release/bundle/macos" -maxdepth 1 -name "*.app" -type d | head -1)"
          if [ -z "${APP_PATH:-}" ]; then
            echo "Could not find .app to sign" >&2
            exit 1
          fi

          if [ ! -f "src-tauri/entitlements.plist" ]; then
            echo "Missing src-tauri/entitlements.plist" >&2
            exit 1
          fi

          echo "Signing identity: $APPLE_SIGNING_IDENTITY"
          echo "App path: $APP_PATH"

          # Clean extended attributes
          xattr -cr "$APP_PATH" || true

          # Sign everything deeply (pragmatic + reliable for CI)
          codesign --force --deep --options runtime --timestamp \
            --entitlements "src-tauri/entitlements.plist" \
            --sign "$APPLE_SIGNING_IDENTITY" \
            "$APP_PATH"

          echo "Verify codesign:"
          codesign --verify --deep --strict --verbose=4 "$APP_PATH"

          echo "Signature details:"
          codesign -dv --verbose=4 "$APP_PATH" 2>&1 | head -120

          echo "Gatekeeper assessment:"
          spctl -a -vv "$APP_PATH" || true

          # Build a fresh DMG from the signed app
          mkdir -p artifacts
          DMG_OUT="artifacts/Production_Portal_universal.dmg"
          rm -f "$DMG_OUT"

          echo "Creating DMG: $DMG_OUT"
          hdiutil create -volname "Production Portal" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_OUT"

          echo "DMG created:"
          ls -lh "$DMG_OUT"

      - name: Notarize + staple DMG (macOS)
  if: matrix.os == 'macos-latest'
  shell: bash
  env:
    APPLE_ID: ${{ secrets.APPLE_ID }}
    APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
    APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
  run: |
    set -euo pipefail

    DMG=$(find "src-tauri/target/universal-apple-darwin/release/bundle/dmg" -name "*.dmg" -type f 2>/dev/null | head -1 || true)
    if [ -z "${DMG:-}" ]; then
      DMG=$(find "src-tauri/target/release/bundle/dmg" -name "*.dmg" -type f 2>/dev/null | head -1 || true)
    fi

    if [ -z "${DMG:-}" ] || [ ! -f "$DMG" ]; then
      echo "Could not find DMG to notarize" >&2
      exit 1
    fi

    retry() {
      local n=0 max=6 delay=20
      until "$@"; do
        n=$((n+1))
        if [ "$n" -ge "$max" ]; then
          echo "Command failed after $n attempts: $*" >&2
          return 1
        fi
        echo "Command failed (attempt $n/$max). Retrying in ${delay}s..." >&2
        sleep "$delay"
        delay=$((delay*2))
      done
    }

    echo "Submitting for notarization (wait): $DMG"

    SUBMIT_JSON="$(retry xcrun notarytool submit "$DMG" \
      --apple-id "$APPLE_ID" \
      --password "$APPLE_APP_SPECIFIC_PASSWORD" \
      --team-id "$APPLE_TEAM_ID" \
      --wait \
      --output-format json)"

    echo "$SUBMIT_JSON"

    UUID="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("id",""))' "$SUBMIT_JSON")"
    STATUS="$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("status",""))' "$SUBMIT_JSON")"

    echo "Notary submission id: $UUID"
    echo "Notary status: $STATUS"

    if [ -z "${UUID:-}" ]; then
      echo "ERROR: Could not extract notary submission id from JSON." >&2
      exit 1
    fi

    if [ "$STATUS" != "Accepted" ]; then
      echo "Notarization not accepted. Fetching log..." >&2
      xcrun notarytool log "$UUID" \
        --apple-id "$APPLE_ID" \
        --password "$APPLE_APP_SPECIFIC_PASSWORD" \
        --team-id "$APPLE_TEAM_ID" || true
      exit 1
    fi

    # Ticket propagation lag happens even after Accepted.
    echo "Waiting for ticket propagation..."
    sleep 120

    echo "Stapling notarization ticket..."
    retry xcrun stapler staple "$DMG"

    echo "Stapler validate..."
    xcrun stapler validate "$DMG" || true

    echo "Gatekeeper verification..."
    spctl -a -vv "$DMG" || true

        
      - name: Collect artifacts (all OS)
        shell: bash
        run: |
          mkdir -p artifacts
          find src-tauri/target/release/bundle -name "*.AppImage" -type f -exec cp {} artifacts/ \; || true
          find src-tauri/target/release/bundle -name "*.deb" -type f -exec cp {} artifacts/ \; || true
          find src-tauri/target/release/bundle -name "*.rpm" -type f -exec cp {} artifacts/ \; || true
          find src-tauri/target/release/bundle -name "*.msi" -type f -exec cp {} artifacts/ \; || true
          find src-tauri/target/release/bundle -name "*.exe" -type f -exec cp {} artifacts/ \; || true
          find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app.tar.gz" -type f -exec cp {} artifacts/ \; || true
          ls -la artifacts || true

      - name: Upload installers
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.platform }}
          if-no-files-found: error
          path: artifacts/
