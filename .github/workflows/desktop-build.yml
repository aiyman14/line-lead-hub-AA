name: Desktop Build

on:
  workflow_dispatch:
  push:
    tags:
      - "desktop-v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x86_64
          - os: windows-latest
            platform: windows-x86_64
          - os: macos-latest
            platform: darwin-universal

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync app version from tag
        if: startsWith(github.ref, 'refs/tags/desktop-v')
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#desktop-v}"
          export VERSION
          echo "Building desktop version: $VERSION"

          python3 -c "import json,os; p='src-tauri/tauri.conf.json'; d=json.load(open(p,'r',encoding='utf-8')); d['version']=os.environ['VERSION']; open(p,'w',encoding='utf-8').write(json.dumps(d,indent=2)+'\n')"
          python3 -c "import os,re,pathlib; v=os.environ['VERSION']; p=pathlib.Path('src-tauri/Cargo.toml'); t=p.read_text(encoding='utf-8'); t=re.sub(r'(?m)^version\\s*=\\s*\"[^\"]+\"\\s*$', f'version = \"{v}\"', t, count=1); p.write_text(t,encoding='utf-8')"

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            librsvg2-dev \
            libsoup-3.0-dev \
            patchelf
          sudo apt-get install -y libayatana-appindicator3-dev || sudo apt-get install -y libappindicator3-dev
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          pkg-config --modversion libsoup-3.0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add macOS universal targets
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Install frontend deps
        run: npm ci

      - name: Write Tauri signing key to file
        shell: bash
        run: |
          mkdir -p ~/.tauri
          printf '%s' "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" > ~/.tauri/production-portal.key
          chmod 600 ~/.tauri/production-portal.key

      - name: Build desktop app (Tauri) - Linux/Windows
        if: matrix.os != 'macos-latest'
        run: npm run tauri:build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build desktop app (Tauri) - macOS Universal
        if: matrix.os == 'macos-latest'
        run: npm run tauri:build -- --target universal-apple-darwin
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Notarize + staple macOS DMG (best-effort staple)
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail

          retry() {
            local n=0
            local max=6
            local delay=20
            until "$@"; do
              n=$((n+1))
              if [ "$n" -ge "$max" ]; then
                echo "Command failed after $n attempts: $*" >&2
                return 1
              fi
              echo "Command failed (attempt $n/$max). Retrying in ${delay}s..." >&2
              sleep "$delay"
              delay=$((delay*2))
            done
          }

          DMG="$(find "src-tauri/target/universal-apple-darwin/release/bundle/dmg" -name "*.dmg" -type f 2>/dev/null | head -1 || true)"
          if [ -z "${DMG:-}" ]; then
            DMG="$(find "src-tauri/target/release/bundle/dmg" -name "*.dmg" -type f 2>/dev/null | head -1 || true)"
          fi

          if [ -z "${DMG:-}" ] || [ ! -f "$DMG" ]; then
            echo "Could not find DMG to notarize" >&2
            find src-tauri/target -maxdepth 10 -type f -name "*.dmg" -print || true
            exit 1
          fi

          echo "Submitting for notarization: $DMG"
          SUBMIT_JSON="$(retry xcrun notarytool submit "$DMG" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --output-format json)"

          echo "Submit output:"
          echo "$SUBMIT_JSON"

          UUID="$(python3 -c "import json,sys; print(json.loads(sys.argv[1]).get('id',''))" "$SUBMIT_JSON")"
          if [ -z "${UUID:-}" ]; then
            echo "Failed to extract notarization submission UUID." >&2
            exit 1
          fi
          echo "Notary submission id: $UUID"

          # Wait for Accepted/Invalid (hard cap 45 minutes)
          MAX_WAIT_SECONDS=2700
          SLEEP_SECONDS=45
          elapsed=0
          STATUS=""

          while [ "$elapsed" -lt "$MAX_WAIT_SECONDS" ]; do
            INFO_JSON="$(retry xcrun notarytool info "$UUID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --output-format json || true)"

            STATUS="$(python3 -c "import json,sys
try:
  d=json.loads(sys.argv[1]); print((d.get('status') or '').strip())
except Exception:
  print('')" "${INFO_JSON:-}")"

            echo "Notary status: ${STATUS:-unknown}"

            if [ "$STATUS" = "Accepted" ]; then
              break
            fi

            if [ "$STATUS" = "Invalid" ] || [ "$STATUS" = "Rejected" ]; then
              echo "Notarization failed. Fetching log..." >&2
              xcrun notarytool log "$UUID" \
                --apple-id "$APPLE_ID" \
                --password "$APPLE_APP_SPECIFIC_PASSWORD" \
                --team-id "$APPLE_TEAM_ID" || true
              exit 1
            fi

            sleep "$SLEEP_SECONDS"
            elapsed=$((elapsed+SLEEP_SECONDS))
          done

          if [ "$STATUS" != "Accepted" ]; then
            echo "Notarization did not reach Accepted within time limit. Fetching log and failing." >&2
            xcrun notarytool log "$UUID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" || true
            exit 1
          fi

          echo "Notarization Accepted."

          # Ticket propagation: retry stapler up to ~30 minutes (this is the issue you keep hitting)
          echo "Attempting stapling with extended propagation retries..."
          STAPLE_OK=0
          for i in $(seq 1 20); do
            echo "Staple attempt $i/20..."
            if xcrun stapler staple "$DMG"; then
              STAPLE_OK=1
              break
            fi
            sleep 90
          done

          if [ "$STAPLE_OK" -eq 1 ]; then
            echo "Stapling succeeded."
            xcrun stapler validate "$DMG" || true
            spctl -a -vv "$DMG" || true
          else
            echo "WARNING: Stapling still failing after retries (ticket propagation/Apple CDN)."
            echo "The DMG is notarized (Accepted), but not stapled. Workflow will continue so you still ship artifacts."
          fi

      - name: Collect artifact info (Linux)
        if: matrix.os == 'ubuntu-22.04'
        shell: bash
        run: |
          mkdir -p artifacts
          APPIMAGE=$(find src-tauri/target/release/bundle -name "*.AppImage" -type f | head -1 || true)
          if [ -n "${APPIMAGE:-}" ] && [ -f "$APPIMAGE" ]; then
            cp "$APPIMAGE" artifacts/
            if [ -f "$APPIMAGE.sig" ]; then
              cat "$APPIMAGE.sig" > artifacts/linux-x86_64.sig
            fi
          fi
          find src-tauri/target/release/bundle -name "*.deb" -exec cp {} artifacts/ \; || true
          find src-tauri/target/release/bundle -name "*.rpm" -exec cp {} artifacts/ \; || true

      - name: Collect artifact info (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          mkdir -p artifacts
          MSI=$(find src-tauri/target/release/bundle -name "*.msi" -type f | head -1 || true)
          if [ -n "${MSI:-}" ] && [ -f "$MSI" ]; then
            cp "$MSI" artifacts/
            if [ -f "$MSI.sig" ]; then
              cat "$MSI.sig" > artifacts/windows-x86_64.sig
            fi
          fi
          find src-tauri/target/release/bundle -name "*.exe" -exec cp {} artifacts/ \; || true

      - name: Collect artifact info (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          mkdir -p artifacts

          MACOS_UPDATE=$(find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app.tar.gz" -type f 2>/dev/null | head -1 || true)
          if [ -z "${MACOS_UPDATE:-}" ]; then
            MACOS_UPDATE=$(find src-tauri/target/release/bundle/macos -name "*.app.tar.gz" -type f 2>/dev/null | head -1 || true)
          fi

          if [ -n "${MACOS_UPDATE:-}" ] && [ -f "$MACOS_UPDATE" ]; then
            cp "$MACOS_UPDATE" artifacts/
            if [ -f "$MACOS_UPDATE.sig" ]; then
              cat "$MACOS_UPDATE.sig" > artifacts/darwin-aarch64.sig
              cat "$MACOS_UPDATE.sig" > artifacts/darwin-x86_64.sig
            fi
          fi

          DMG=$(find src-tauri/target/universal-apple-darwin/release/bundle -name "*.dmg" -type f 2>/dev/null | head -1 || true)
          if [ -z "${DMG:-}" ]; then
            DMG=$(find src-tauri/target/release/bundle -name "*.dmg" -type f 2>/dev/null | head -1 || true)
          fi
          if [ -n "${DMG:-}" ] && [ -f "$DMG" ]; then
            cp "$DMG" artifacts/
          fi

      - name: Upload installers
        uses: actions/upload-artifact@v4
        with:
          name: installers-${{ matrix.platform }}
          if-no-files-found: error
          path: artifacts/

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/desktop-v')

    steps:
      - name: Download all installers
        uses: actions/download-artifact@v4
        with:
          pattern: installers-*
          path: dist
          merge-multiple: true

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find dist -type f -ls

      - name: Create Release + Upload Assets
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Production Portal ${{ github.ref_name }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: |
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.dmg
            dist/*.app.tar.gz
            dist/*.msi
            dist/*.exe
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate latest.json (use actual uploaded asset URLs)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          TAG="${{ github.ref_name }}"
          VERSION="${TAG#desktop-v}"
          REPO="WovenTexLTD/line-lead-hub"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG" \
            > dist/release.json

          LINUX_URL=$(jq -r '.assets[] | select(.name|endswith(".AppImage")) | .browser_download_url' dist/release.json | head -n1)
          WINDOWS_URL=$(jq -r '.assets[] | select(.name|endswith(".msi")) | .browser_download_url' dist/release.json | head -n1)
          MACOS_URL=$(jq -r '.assets[] | select(.name|endswith(".app.tar.gz")) | .browser_download_url' dist/release.json | head -n1)

          [ -n "$LINUX_URL" ] || (echo "Missing Linux URL" >&2; exit 1)
          [ -n "$WINDOWS_URL" ] || (echo "Missing Windows URL" >&2; exit 1)
          [ -n "$MACOS_URL" ] || (echo "Missing macOS URL" >&2; exit 1)

          LINUX_SIG=$(tr -d '\n' < dist/linux-x86_64.sig)
          WINDOWS_SIG=$(tr -d '\n' < dist/windows-x86_64.sig)

          DARWIN_SIG=""
          if [ -f "dist/darwin-aarch64.sig" ]; then
            DARWIN_SIG=$(tr -d '\n' < dist/darwin-aarch64.sig)
          elif [ -f "dist/darwin-x86_64.sig" ]; then
            DARWIN_SIG=$(tr -d '\n' < dist/darwin-x86_64.sig)
          fi
          [ -n "$DARWIN_SIG" ] || (echo "Missing macOS sig" >&2; exit 1)

          cat > dist/latest.json <<EOF
          {
            "version": "$VERSION",
            "notes": "Production Portal update",
            "pub_date": "$PUB_DATE",
            "platforms": {
              "linux-x86_64": { "url": "$LINUX_URL", "signature": "$LINUX_SIG" },
              "windows-x86_64": { "url": "$WINDOWS_URL", "signature": "$WINDOWS_SIG" },
              "darwin-aarch64": { "url": "$MACOS_URL", "signature": "$DARWIN_SIG" },
              "darwin-x86_64": { "url": "$MACOS_URL", "signature": "$DARWIN_SIG" }
            }
          }
          EOF

      - name: Upload latest.json
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: dist/latest.json
          token: ${{ secrets.GITHUB_TOKEN }}
